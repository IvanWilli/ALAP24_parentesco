---
title: "Escuela Familia, parentesco y hogares en América Latina y el Caribe"
subtitle: "XI Congreso de la Asociación Latinoamericana de Población (ALAP); Bogotá, Diciembre 10, 2024"
author: "Instructors: Amanda Martins de Almeida, Liliana P. Calderon-Bernal, Ivan Williams & Diego Alburez-Gutierrez"
date: "Updated: `r Sys.Date()`"

output:
  html_document:
    # toc_depth: 2
    toc_float: true
    # number_sections: true
    theme: readable
    highlight: pygments
    # code_folding: hide
bibliography: kinship.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE, 
                      warning = FALSE, 
                      fig.align='center')

# Prevent scientific notation (useful for the rate calculation)
options(scipen=999999)
```


# {.tabset}
## Introducion

#### Descripción del curso: 

El parentesco es una propiedad fundamental de las poblaciones humanas y una forma clave de estructura social.
Los demógrafos llevan mucho tiempo interesados en la interacción entre el cambio demográfico y la configuración familiar.
Esto ha llevado al desarrollo de sofisticados enfoques metodológicos y conceptuales para el estudio del parentesco, algunos de los cuales se revisan en este curso. 

Algunas cosas útiles que hay que saber:

- Las diapositivas del curso están disponibles aquí: [UPDATE with DIEGO's slides??]
- Encuentre el código fuente de este sitio web en GitHub: https://github.com/amandamartinsal/ALAP24_parentesco

![](Picture4.png)

<!-- Sesión de laboratorio 1: Simulación con rsocsim -->

## rsocsim 

<!-- Sesión de laboratorio 2: Modelos en DemoKin -->

## DemoKin 

#### Introducción a los modelos matriciales de parentesco en R utilizando DemoKin

Pronto comenzaremos las sesiones de laboratorio informático, por lo que sería estupendo haber preparado de antemano el entorno R. En primer lugar, necesitarás R y Rstudio instalados. Segundo, ¡instala el DemoKin! 

<img src="DemoKin-Logo.png" align="right" width="200" />

- [Instalación](#instalacion)

- [Modelo variable en el tiempo: un sexo](#modelo_variablunsexo)

- [Modelo variable en el tiempo: dos sexos](#modelo_variable_dos)

- [Enfoque por periodo](#periodo)

- [Ejercicio](#ejercicio)


#### 1. Instalación {#instalacion}

```{r,warning=F, message=FALSE}
#Install the development version from GitHub

#install.packages("devtools")
#devtools::install_github("IvanWilli/DemoKin")
```

##### 1.1 Cargar otros paquetes que puedan ser útiles:

```{r, warning=F, message=FALSE}
library(DemoKin)
library(dplyr)
library(tidyr)
library(ggplot2)
library(data.table)
library(readr)
```

#### 2. Modelo variable en el tiempo: un sexo {#modelo_variablunsexo}

Las tasas demográficas cambian cada año, lo que significa que Focal y sus parientes habrán experimentado tasas de mortalidad y fecundidad cambiantes a lo largo del tiempo.
Empezaremos a construir las estructuras de parentesco en un modelo variable en el tiempo sólo con tasas femeninas: modelo invariante en el tiempo de un sexo.

Podemos acceder a las tasas demográficas de cualquier país del mundo, elaboradas por el proyecto World Population Prospects (WPP).
En los ejemplos utilizaremos los datos de fecundidad, mortalidad y población de Colombia desde 1950 hasta 2023.
En el archivo de datos también encontrará datos de Argentina, Brasil y México.

Carguemos primero los datos para las mujeres en Colombia de 1950 a 2023

```{r, warning=FALSE, message=FALSE}
#Load data

col_female <- read_csv("data/col_female.csv") #female rates
col_popfemale <- read_csv("data/col_popfemale.csv") #female population (N)
```

Tenemos que remodelar la fecundidad y la mortalidad para crear una matriz que pueda utilizar DemoKin (es decir, crear una matriz con los años como columnas y las edades como filas):

```{r, message=FALSE, warning=FALSE }
# Reshape fertility
col_asfr <- col_female %>%
  select(age, year, fx) %>%
  pivot_wider(names_from = year, values_from = fx) %>%
  select(-age) %>%
  as.matrix()

# Reshape survival
col_px_female <- col_female %>%
  select(age, year, px) %>%
  pivot_wider(names_from = year, values_from = px) %>%
  select(-age) %>%
  as.matrix()
```

Los datos que estamos utilizando tienen años en columnas y edades en filas. Aquí, trazamos $q_x$ (complemento de p) sobre la edad y el tiempo:

```{r}
col_px_female %>%
    as.data.frame() %>%
    mutate(age = 1:nrow(col_px_female)-1) %>%
    pivot_longer(-age, names_to = "year", values_to = "px") %>%
    mutate(qx = 1-px) %>%
    ggplot() +
    geom_line(aes(x = age, y = qx, col = year)) +
    scale_y_log10() +
    theme(legend.position = "none")
```

Tasas de fecundidad por edades:

```{r}
col_asfr %>% as.data.frame() %>%
     mutate(age = 1:nrow(col_asfr)-1) %>%
     pivot_longer(-age, names_to = "year", values_to = "asfr") %>%
     mutate(year = as.integer(year)) %>%
     ggplot() + geom_tile(aes(x = year, y = age, fill = asfr)) +
     scale_x_continuous(breaks = seq(1900,2020,10), labels = seq(1900,2020,10))
```

Y población femenina por edad:

```{r}
col_popfemale %>%
     mutate(age = 1:nrow(col_popfemale)-1) %>%
     pivot_longer(-age, names_to = "year", values_to = "pop") %>%
     mutate(year = as.integer(year)) %>%
     ggplot() + geom_tile(aes(x = year, y = age, fill = pop)) +
     scale_x_continuous(breaks = seq(1900,2020,10), labels = seq(1900,2020,10))
```

Con esta información podemos modelizar la estructura de parentesco en dimensiones Edad-Periodo-Cohorte (APC):

![](apc.png)

##### 2.1 La función `Kin()`
La función `DemoKin` se puede utilizar para calcular el número y la distribución de edad de los parientes de Focal bajo una serie de supuestos, incluyendo parientes vivos y fallecidos. La función `DemoKin::kin()` realiza actualmente la mayor parte del trabajo pesado en términos de implementación de modelos matriciales de parentesco.

Argumentos en un entorno variable en el tiempo:

1) p numérico. Un vector (atómico) o matriz de probabilidades de supervivencia con filas como edades (y columnas como años en caso de matriz).
2) f numérico. Igual que p pero para las tasas de fecundidad.
3) n numeric.Sólo para time_invariant = FALSE. Para la distribución de la población.
4) time_invariant logical. Suponemos tasas variables en el tiempo, entonces = FALSE.
5) output_cohort integer. Vector de cohortes de años para devolver los resultados. Debe estar dentro del intervalo de años de los datos de entrada.
6) output_cohort entero. Igual que output_cohort, pero vector de años del periodo para devolver resultados.
7) output_kin carácter. tipos de parentesco a devolver: «m» para madre, “d” para hija, ...

Ejecutamos un modelo de parentesco de un sexo invariante en el tiempo para una cohorte de 1993:

```{r, warning=FALSE, message=FALSE}
col_1993 <-
  kin(p = col_px_female,
      f = col_asfr,
      n = col_popfemale,
      time_invariant = FALSE,
      output_cohort = 1993)
```

##### 2.2 Enfoque de cohortes

Utilizamos el argumento `output_cohort = 1993`. La salida de este modelo de parentesco son los parientes vivos que para una mujer media nacida en 1993, dada la fecundidad variable en el tiempo, la mortalidad y la distribución de la población para el periodo 1950-2023. Nótese el argumento `output_cohort = 1993`, utilizado para extraer estimaciones para una cohorte dada de Focales (una diagonal en el diagrama Lexis). Se trata de un subconjunto de todos los resultados posibles (101 clases de edad y 73 años (1950 - 2023)). Las estimaciones se detienen a los 30 años porque sólo hemos proporcionado datos de entrada (de periodo) hasta el año 2023 (`2023 - 19930 = 30`).

##### 2.3 Diagrama de parentesco de Keyfitz

Podemos visualizar los recuentos de parentesco implícitos para una mujer Focal de 30 años en 2023 (nacida en 1993) en una población variable en el tiempo utilizando una red o un diagrama de parentesco de 'Keyfitz' [@Keyfitz2005] con la función `plot_diagram`:

```{r, fig.height=10, fig.width=12}
col_1993$kin_summary %>% 
  filter(age_focal == 30) %>% 
  select(kin, count = count_living) %>% 
  plot_diagram(rounding = 2)
```

##### 2.4 Parientes vivos

Ahora, visualicemos cómo cambia el número esperado de hijas, hermanos, primos, etc., a lo largo de la vida de Focal.

```{r}
col_1993$kin_summary %>%
  rename_kin() %>%
  ggplot() +
  geom_line(aes(age_focal, count_living))  +
  theme_bw() +
  labs(x = "Age of focal", y= "Number of living female relatives") +
  facet_wrap(~kin_label)
```

En el gráfico anterior podemos ver el número de parientes femeninos vivos para la cohorte nacida en 1993.
Antes de profundizar en la estructura de parentesco de Colombia, añadamos los parientes masculinos.

#### 3. Modelo variable en el tiempo: dos sexos {#modelo_variable_dos}

En general, los hombres viven menos y se reproducen más tarde que las mujeres. Estos procesos específicos del sexo afectan a la dinámica del parentesco de varias maneras. Por ejemplo, el grado en que un miembro medio de la población, llámese Focal, tiene un abuelo vivo se ve afectado por la mortalidad diferencial que afecta a la generación parental a edades más avanzadas. También nos puede interesar estudiar cómo varían las estructuras de parentesco según el sexo del Focal: un Focal varón puede tener un número diferente de nietos que una Focal mujer, dadas las diferencias de fertilidad según el sexo. Documentar estas diferencias es importante, ya que las mujeres suelen tener mayores expectativas de proporcionar apoyo y cuidados informales a sus familiares. A medida que viven más años, corren un mayor riesgo de no tener parientes vivos.
La función `kin2sex` implementa un modelo de parentesco de dos sexos.

Dado que disponemos de la supervivencia y la población masculinas en el proyecto World Population Prospects (WPP), podemos guardar estos datos para utilizarlos en la función `kin2sex`.

```{r, warning=FALSE, message=FALSE}
#Load data

col_male <- read_csv("data/col_male.csv") #male rates
col_popmale <- read_csv("data/col_popmale.csv") #male population (N)
```

Tenemos que remodelar la mortalidad para crear una matriz que pueda utilizar DemoKin (es decir, crear una matriz con los años como columnas y las edades como filas):

```{r, message=FALSE, warning=FALSE}
# Reshape survival

col_px_male <- col_male %>%
  select(age, year, px) %>%
  pivot_wider(names_from = year, values_from = px) %>%
  select(-age) %>%
  as.matrix()
```

Sin embargo, ¿para cuántos países se dispone de información sobre la fecundidad masculina?

Dado que no tenemos información sobre la fecundidad masculina a lo largo del tiempo para Colombia, utilizaremos el supuesto andrógino de que los hombres y las mujeres tienen las mismas tasas de fecundidad.

Ahora introducimos la función `kin2sex`, que es similar a la función de un sexo `kin` (ver `?kin`) con dos excepciones. En primer lugar, el usuario necesita especificar la mortalidad y la fecundidad por sexo. En segundo lugar, necesita indicar el sexo de Focal (que se supone femenino por defecto, como en el modelo de un solo sexo).

Vamos a ejecutar un modelo de parentesco de dos sexos variable en el tiempo considerando el supuesto andrógino, hombre y mujer tienen las mismas tasas de fertilidad:

```{r,message=FALSE, warning=FALSE}
col_2sex_1993 <- kin2sex(
  pf = col_px_female,
  pm = col_px_male,
  ff = col_asfr,
  fm = col_asfr,
  nf = col_popfemale,
  nm = col_popmale,
  time_invariant = FALSE,
  output_cohort = 1993,
  sex_focal = "f",
  birth_female = .5)
```

La salida de `kin2sex` es equivalente a la de `kin`, salvo que incluye una columna `sex_kin` para especificar el sexo de los familiares dados. Eche un vistazo con `head(col_kin_2sex$kin_summary)`.

```{r}
head(col_2sex_1993$kin_summary)
```

> Una nota sobre terminología:
La función `kin2sex` utiliza los mismos códigos que `kin` para identificar a los parientes (véase `demokin_codes()`).
Tenga en cuenta que cuando se ejecuta un modelo de dos sexos, ¡el código «m» se refiere a madres o padres!
Utilice la columna `sex_kin` para filtrar el sexo de un pariente determinado.
Por ejemplo, para considerar sólo a los hijos e ignorar a las hijas, utilice:

```{r}
col_2sex_1993$kin_summary %>%
  filter(kin == "d", sex_kin == "m") %>%
  head()
```

##### 3.1 Parientes vivos

Ahora podemos visualizar cómo es el número esperado de parientes vivos según el sexo y la edad del Focal.

```{r}
  col_2sex_1993$kin_summary %>%
  rename_kin(sex = "2sex") %>% 
  summarise(count=sum(count_living), .by = c(kin_label, age_focal, sex_kin)) %>%
  ggplot(aes(age_focal, count, fill=sex_kin)) +
  geom_area() +
  theme_bw() +
  labs(y = "Expected number of living kin by sex and Focal's age",
       x = "Age of Focal",
       fill = "Sex of Kin") +
  facet_wrap(~kin_label)
```

##### 3.2 Muerte de parientes

La pérdida de familiares puede tener graves consecuencias para los familiares en duelo, ya que afecta, por ejemplo, a la prestación de apoyo asistencial y a las transferencias intergeneracionales a lo largo de la vida.
La función `kin` proporciona información sobre el número de familiares perdidos por Focal durante su vida, almacenada en la columna `kin_summary$count_cum_death`. El gráfico siguiente compara los patrones de pérdida de parientes para la cohorte de 1993 (30 años en 2023) por sexo del pariente.

```{r,message=FALSE, warning=FALSE, eval=T}
col_2sex_1993$kin_summary %>%
  rename_kin(sex = "2sex") %>%
  summarise(count=sum(count_dead), .by = c(kin_label, sex_kin, age_focal)) %>%
  ggplot(aes(age_focal, count, col=sex_kin))+
  geom_line()+
  theme_bw() +
  labs(y = "Expected number of deceased kin by sex and Focal's age",
       x = "Age of Focal",
       col = "Sex of Kin") +
  facet_wrap(~kin_label)
```

##### 3.3 Proporción de sexos

La información sobre la disponibilidad de parientes por sexo nos permite considerar las proporciones de sexos, una medida tradicional en demografía, con las mujeres a menudo en el denominador. La siguiente figura, por ejemplo, muestra que una mujer colombiana de 30 años en 2023 puede esperar tener 0,5 abuelos por cada abuela. ¿Es siempre cierto que la proporción de sexos disminuirá a la edad de Focal?

<!-- Bueno, debido a la mortalidad sí (y también los hombres son mayores cuando tienen hijos), pero depende de la proporción de sexos al nacer, podría cambiar si hay alguna preferencia por los varones y la proporción no está equilibrada alrededor de .5 -->

```{r, message=FALSE, warning=FALSE}
col_2sex_1993$kin_summary %>%
  rename_kin(sex = "2sex") %>%
  group_by(kin_label, age_focal) %>%
  summarise(sex_ratio = sum(count_living[sex_kin=="m"], na.rm=T)/sum(count_living[sex_kin=="f"], na.rm=T)) %>%
  ggplot(aes(age_focal, sex_ratio))+
  geom_line()+
  theme_bw() +
  labs(y = "Sex ratio",
       x = "Age of Focal") +
  facet_wrap(~kin_label, scales = "free")
```

La experiencia de pérdida de parentesco para los focales depende de las diferencias de mortalidad entre sexos. Una mujer Focal empieza a perder a sus padres antes que a sus madres. Vemos un patrón ligeramente diferente para los abuelos, ya que la experiencia de Focal de la pérdida de abuelos depende de la disponibilidad inicial de abuelos (es decir, si el abuelo de Focal murió antes de su nacimiento, nunca experimentará su muerte). 

#### 4. Enfoque por periodos {#periodo}

Hasta ahora hemos utilizado el parámetro `output_cohort`, en esta sección exploraremos el `output_period`.
Quizás esté interesado en tomar una instantánea de la distribución de parientes en algún año, por ejemplo 2023. Puede hacerlo especificando el argumento `output_period = 2023`.

```{r, message=FALSE, warning=FALSE}
col_2sex_2023 <- kin2sex(
  pf = col_px_female,
  pm = col_px_male,
  ff = col_asfr,
  fm = col_asfr,
  nf = col_popfemale,
  nm = col_popmale,
  time_invariant = FALSE,
  output_period = 2023,
  sex_focal = "f",
  birth_female = .5)
```

Tracemos el número esperado de parientes vivos por sexo y edad del Focal:

```{r}
col_2sex_2023$kin_summary %>%
  rename_kin(sex = "2sex") %>%
  ggplot(aes(age_focal, count_living, col=sex_kin)) +
  geom_line()+
  theme_bw() +
  labs(y = "Expected number of living kin by sex and Focal's age",
       x = "Age of Focal",
       col = "Sex of Kin") +
  facet_wrap(~kin_label)
```

¿Se parecen estos gráficos de «periodos» a los gráficos de «cohortes» mostrados anteriormente? ¿En qué casos preferiría un enfoque de período a uno de cohorte?

##### 4.1 A DemoKin no le gustan las combinaciones cohorte-período

> `DemoKin` sólo devolverá valores para periodos O cohortes, pero nunca para combinaciones periodo-cohorte. Esto está relacionado con problemas de tiempo/memoria. 

Considere el siguiente código, que dará un error ya que estamos pidiendo **tanto** una salida de cohorte como de período al mismo tiempo:

```{r, error=TRUE}
kin2sex(
  pf = col_px_female,
  pm = col_px_male,
  ff = col_asfr,
  fm = col_asfr,
  nf = col_popfemale,
  nm = col_popmale,
  time_invariant = FALSE,
  output_cohort = 1963,
  output_period = 2023,
  sex_focal = "f",
  birth_female = .5)
```

#### 5. Ejercicio {#ejercicio}

Elija un país de la carpeta de datos (Argentina, Brasil o México) y responda a las siguientes preguntas:

¿Cuál es la relación entre la transición demográfica y la red de parentesco en este país?
¿Crees que podemos observar indicios de una «transición de parentesco»?
Utiliza los datos para explorar y apoyar tu respuesta.

